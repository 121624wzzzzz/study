# WSL2 Ubuntu 深度学习环境配置完整指南

> 配置日期: 2025年10月19日  
> 适用系统: WSL2 + Ubuntu  
> 硬件环境: RTX 4090 / CUDA 12.1

---

## 目录
1. [系统初始化](#1-系统初始化)
2. [Miniconda 安装与配置](#2-miniconda-安装与配置)
3. [镜像源配置](#3-镜像源配置)
4. [Python 环境模板创建](#4-python-环境模板创建)
5. [SSH 远程访问配置](#5-ssh-远程访问配置)
6. [Tmux 会话管理](#6-tmux-会话管理)
7. [工作目录结构](#7-工作目录结构)
8. [Git 配置](#8-git-配置)
9. [Bash 配置优化](#9-bash-配置优化)
10. [环境验证](#10-环境验证)
11. [常见使用场景](#11-常见使用场景)
12. [故障排查](#12-故障排查)

---

## 1. 系统初始化

### 1.1 更新系统
```bash
sudo apt-get update && sudo apt-get upgrade -y
```

### 1.2 安装基础开发工具
```bash
sudo apt-get install -y \
    build-essential \
    git \
    wget \
    curl \
    vim \
    tmux \
    htop \
    tree \
    zip \
    unzip \
    openssh-server
```

---

## 2. Miniconda 安装与配置

### 2.1 下载并安装 Miniconda
```bash
# 下载
cd ~
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# 安装
bash Miniconda3-latest-Linux-x86_64.sh -b -p $HOME/miniconda3

# 初始化
~/miniconda3/bin/conda init bash
source ~/.bashrc
```

### 2.2 配置 Conda 行为
```bash
# 禁止自动激活 base 环境
conda config --set auto_activate_base false
```

---

## 3. 镜像源配置

### 3.1 Conda 镜像源（清华源）
```bash
cat > ~/.condarc << 'EOF'
channels:
  - defaults
show_channel_urls: true
default_channels:
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
  pytorch: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
channel_priority: flexible
EOF

# 清除缓存
conda clean -i -y
```

### 3.2 接受 Conda 服务条款
```bash
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
```

### 3.3 配置 pip 镜像源（清华源）
```bash
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

### 3.4 配置 HuggingFace 镜像
```bash
echo 'export HF_ENDPOINT=https://hf-mirror.com' >> ~/.bashrc
source ~/.bashrc
```

---

## 4. Python 环境模板创建

### 4.1 创建模板环境
```bash
# 创建 Python 3.10 环境
conda create -n template python=3.10 -y

# 激活环境
conda activate template
```

### 4.2 安装 PyTorch (CUDA 12.1 适配 RTX 4090)
```bash
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### 4.3 安装核心深度学习库
```bash
pip install transformers==4.44.2
pip install datasets==2.21.0
pip install accelerate==0.34.2
pip install peft==0.12.0
pip install bitsandbytes==0.44.1
pip install scipy
```

### 4.4 安装监控和工具库
```bash
pip install tensorboard wandb tqdm
pip install scikit-learn rouge-score nltk
```

### 4.5 安装数据处理库
```bash
pip install pandas numpy matplotlib seaborn
```

### 4.6 安装开发工具
```bash
pip install jupyter ipython ipywidgets
```

### 4.7 验证安装
```bash
python << 'EOF'
import torch
import transformers
import datasets
import peft
print(f"✅ PyTorch: {torch.__version__}")
print(f"✅ CUDA: {torch.cuda.is_available()}")
print(f"✅ GPU: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'N/A'}")
print(f"✅ Transformers: {transformers.__version__}")
print(f"✅ 所有核心库安装成功！")
EOF
```

### 4.8 创建环境克隆脚本
```bash
# 创建克隆脚本
cat > ~/clone_env.sh << 'EOF'
#!/bin/bash

if [ -z "$1" ]; then
    echo "用法: ./clone_env.sh <新环境名>"
    exit 1
fi

NEW_ENV=$1

echo "正在从 template 克隆环境到 $NEW_ENV ..."
conda create -n $NEW_ENV --clone template -y

echo "✅ 环境 $NEW_ENV 创建完成！"
echo "激活环境: conda activate $NEW_ENV"
EOF

# 添加执行权限
chmod +x ~/clone_env.sh
```

**使用示例：**
```bash
~/clone_env.sh my-project
```

---

## 5. SSH 远程访问配置

### 5.1 WSL2 侧配置

#### 修改 SSH 端口（避免与 Windows SSH 冲突）
```bash
sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
```

#### 启动 SSH 服务
```bash
sudo service ssh start
```

#### 配置自动启动
```bash
echo 'sudo service ssh start 2>/dev/null' >> ~/.bashrc
```

#### 配置 sudo 免密码启动 SSH
```bash
echo "$USER ALL=(ALL) NOPASSWD: /usr/sbin/service ssh start" | sudo tee /etc/sudoers.d/ssh-start
```

### 5.2 Windows 侧配置（需管理员权限）

#### 添加端口转发规则
```powershell
# 获取 WSL2 IP 地址
$wslIP = (wsl hostname -I).Trim()

# 添加端口转发规则
netsh interface portproxy add v4tov4 listenport=2222 listenaddress=0.0.0.0 connectport=2222 connectaddress=$wslIP

# 添加防火墙规则
New-NetFirewallRule -DisplayName "WSL SSH" -Direction Inbound -LocalPort 2222 -Protocol TCP -Action Allow

# 验证端口转发规则
netsh interface portproxy show all
```

### 5.3 SSH 连接测试

#### 从其他设备连接
```bash
ssh -p 2222 wz@<Windows主机IP>
```

#### 配置 SSH 免密登录（可选）
```bash
# 在客户端机器上生成密钥
ssh-keygen -t ed25519 -C "your.email@example.com"

# 将公钥复制到 WSL2
ssh-copy-id -p 2222 wz@<Windows主机IP>
```

---

## 6. Tmux 会话管理

### 6.1 配置 Tmux
```bash
cat > ~/.tmux.conf << 'EOF'
# 鼠标支持
set -g mouse on

# 状态栏样式
set -g status-bg colour235
set -g status-fg colour136

# 会话名显示
set -g status-left '#[fg=green](#S) '

# 窗口索引从 1 开始
set -g base-index 1
set -g pane-base-index 1
EOF
```

### 6.2 Tmux 常用命令
```bash
# 创建新会话
tmux new -s session_name

# 列出所有会话
tmux ls

# 重新连接会话
tmux attach -t session_name

# 分离会话（任务继续运行）
# 快捷键: Ctrl+B, 然后按 D

# 删除会话
tmux kill-session -t session_name

# 在会话中创建新窗口
# 快捷键: Ctrl+B, 然后按 C

# 切换窗口
# 快捷键: Ctrl+B, 然后按 0-9
```

---

## 7. 工作目录结构

### 7.1 创建标准工作目录
```bash
mkdir -p ~/workspace/{projects,datasets,models,scripts,notebooks}
```

### 7.2 目录说明
- `~/workspace/projects` - 项目代码
- `~/workspace/datasets` - 数据集
- `~/workspace/models` - 模型权重
- `~/workspace/scripts` - 脚本文件
- `~/workspace/notebooks` - Jupyter notebooks

---

## 8. Git 配置

```bash
# 配置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 配置默认编辑器
git config --global core.editor vim

# 配置默认分支名
git config --global init.defaultBranch main

# 查看配置
git config --list
```

---

## 9. Bash 配置优化

### 9.1 添加配置到 ~/.bashrc
```bash
cat >> ~/.bashrc << 'EOF'

# ============ 自动启动服务 ============
sudo service ssh start 2>/dev/null

# ============ 环境变量 ============
export HF_ENDPOINT=https://hf-mirror.com
export WORKSPACE=~/workspace

# ============ 常用别名 ============
# 文件操作
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# Git 快捷命令
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git pull'
alias gps='git push'

# Conda 环境管理
alias ca='conda activate'
alias cda='conda deactivate'
alias clist='conda env list'
alias cclone='~/clone_env.sh'
alias crm='conda env remove -n'

# 工作区快捷跳转
alias ws='cd $WORKSPACE'
alias proj='cd $WORKSPACE/projects'
alias data='cd $WORKSPACE/datasets'
alias models='cd $WORKSPACE/models'

# tmux 快捷命令
alias tl='tmux ls'
alias ta='tmux attach -t'
alias tn='tmux new -s'
EOF
```

### 9.2 应用配置
```bash
source ~/.bashrc
```

---

## 10. 环境验证

### 10.1 系统工具检查
```bash
# 检查系统工具
git --version
conda --version
tmux -V
ssh -V
python --version
```

### 10.2 Conda 环境检查
```bash
conda env list
```

### 10.3 镜像配置检查
```bash
echo $HF_ENDPOINT
pip config list
cat ~/.condarc
```

### 10.4 PyTorch 和 CUDA 检查
```bash
conda activate template
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}'); print(f'GPU: {torch.cuda.get_device_name(0)}')"
```

### 10.5 SSH 服务检查
```bash
sudo service ssh status
ss -tlnp | grep 2222
```

### 10.6 工作目录检查
```bash
ls -la ~/workspace/
```

---

## 11. 常见使用场景

### 场景 1: 创建新项目环境并开始训练

```bash
# 1. 克隆模板环境
~/clone_env.sh llama-lora

# 2. 激活环境
conda activate llama-lora

# 3. 安装项目特定依赖
pip install flash-attn

# 4. 使用 tmux 保持训练
tmux new -s training
cd ~/workspace/projects/llama-lora
python train.py

# 5. 分离 tmux（Ctrl+B, D）
# 训练继续在后台运行
```

### 场景 2: 远程查看训练进度

```bash
# 1. 从远程机器 SSH 连接
ssh -p 2222 wz@<Windows_IP>

# 2. 查看现有 tmux 会话
tmux ls

# 3. 连接到训练会话
tmux attach -t training

# 4. 检查训练状态
# 查看 GPU 使用情况
nvidia-smi

# 5. 查看日志
tail -f train.log

# 6. 分离会话继续训练
# Ctrl+B, D
```

### 场景 3: 使用 Jupyter Notebook

```bash
# 1. 激活环境
conda activate template

# 2. 启动 Jupyter
cd ~/workspace/notebooks
jupyter notebook --no-browser --port=8888

# 3. 在本地浏览器访问
# http://localhost:8888
```

---

## 12. 故障排查

### 问题 1: SSH 无法连接

**解决方案：** 在 Windows PowerShell（管理员）中重新配置端口转发
```powershell
$wslIP = (wsl hostname -I).Trim()
netsh interface portproxy delete v4tov4 listenport=2222 listenaddress=0.0.0.0
netsh interface portproxy add v4tov4 listenport=2222 listenaddress=0.0.0.0 connectport=2222 connectaddress=$wslIP
```

### 问题 2: Conda 环境创建失败

**解决方案：** 清除缓存重试
```bash
conda clean -a -y
conda create -n template python=3.10 -y
```

### 问题 3: PyTorch 无法识别 GPU

**解决方案：** 检查 CUDA 驱动并重新安装
```bash
# 检查 CUDA 驱动
nvidia-smi

# 重新安装正确的 PyTorch 版本
pip uninstall torch torchvision torchaudio -y
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

---

## 附录：快速参考卡

### Conda 环境管理
```bash
clist          # 列出所有环境
ca <env>       # 激活环境
cda            # 退出环境
cclone <new>   # 克隆模板环境
crm <env>      # 删除环境
```

### Tmux 会话管理
```bash
tl             # 列出会话
tn <name>      # 创建新会话
ta <name>      # 连接会话
Ctrl+B, D      # 分离会话
```

### 工作区快捷跳转
```bash
ws             # 跳转到工作区根目录
proj           # 跳转到项目目录
data           # 跳转到数据集目录
models         # 跳转到模型目录
```

### Git 快捷命令
```bash
gs             # git status
ga             # git add
gc             # git commit
gp             # git pull
gps            # git push
```

---

**配置完成！开始你的深度学习之旅吧！** 🚀